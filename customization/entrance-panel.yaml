################################################################################
#  Waveshare ESP32-S3-Touch-LCD-7  â€”  Home Dashboard
#  ESPHome firmware
#
#  Layout (800Ã—480, dark theme):
#  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#  â”‚  ğŸ• TIME & DATE (left)          ğŸŒ¤ WEATHER (right)                     â”‚  â† header 110px
#  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
#  â”‚  ğŸ’¡ LIGHTS                      ğŸ¬ SCENES                              â”‚
#  â”‚  [ Living Room ] [ Kitchen  ]   [ Evening  ] [ Movie    ]              â”‚
#  â”‚  [ Dining Room ] [ Outdoor  ]   [ Morning  ] [ Goodnight]              â”‚
#  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
#  KEY FIX: pclk_frequency reduced from 16MHz to 8MHz and bounce buffers
#  enabled to prevent the RGB LCD DMA from starving the WiFi task.
#
#  secrets.yaml should contain:
#    wifi_ssid: "YourNetwork"
#    wifi_password: "YourPassword"
#    api_encryption_key: "generate a 32-byte base64 key in HA"
#    ota_password: "choose-any-password"
################################################################################

substitutions:
  device_name:     entrance-dashboard
  friendly_name:   "Entrance Dashboard"


################################################################################
# Board & framework
################################################################################
esphome:
  name: entrance-panel
  platformio_options:
    build_flags: "-DBOARD_HAS_PSRAM"
    board_build.arduino.memory_type: qio_opi
    board_build.flash_mode: dio
    board_upload.maximum_ram_size: 524288
    board_upload.maximum_size: 8388608

psram:
  mode: octal
  speed: 80MHz

esp32:
  board: esp32-s3-devkitc-1
  variant: ESP32S3
  flash_size: 8MB
  framework:
    type: esp-idf
    sdkconfig_options:
      COMPILER_OPTIMIZATION_SIZE: y
      CONFIG_ESP32S3_DATA_CACHE_64KB:         "y"
      CONFIG_ESPTOOLPY_FLASHSIZE_8MB:         "y"
      CONFIG_FREERTOS_HZ:                     "1000"
      CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240:    "y"
      CONFIG_SPIRAM_FETCH_INSTRUCTIONS:       y
      CONFIG_SPIRAM_RODATA:                   y
      CONFIG_ESP32S3_DATA_CACHE_LINE_64B:     y
      # â”€â”€ RGB LCD + WiFi coexistence â”€â”€
      CONFIG_LCD_RGB_ISR_IRAM_SAFE:           y
      CONFIG_LCD_RGB_RESTART_IN_VSYNC:        y
      CONFIG_ESP_WIFI_IRAM_OPT:              y
      CONFIG_ESP_WIFI_RX_IRAM_OPT:           y
      CONFIG_LWIP_IRAM_OPTIMIZATION:          y


################################################################################
# Core services
################################################################################
logger:
  level: WARN
  hardware_uart: USB_SERIAL_JTAG
  logs:
    component: ERROR

api:
  reboot_timeout: 5min
  encryption:
    key: !secret api_encryption_key

ota:
  platform: esphome
  password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  output_power: 17
  power_save_mode: NONE
  reboot_timeout: 5min
  ap:
    ssid: "${device_name}-fallback"
    password: !secret ota_password

captive_portal:


################################################################################
# Time
################################################################################
time:
  - platform: homeassistant
    id: ha_time


################################################################################
# IÂ²C bus
################################################################################
i2c:
  sda: GPIO08
  scl: GPIO09
  scan: false
  id: bus_a


################################################################################
# CH422G IO expander
################################################################################
ch422g:
  - id: ch422g_hub


################################################################################
# Switches
################################################################################
switch:
  - platform: gpio
    id: lcd_backlight
    name: "Screen Backlight"
    pin:
      ch422g: ch422g_hub
      number: 2
      mode:
        output: true
      inverted: false
    restore_mode: ALWAYS_ON

  - platform: restart
    name: "Dashboard Restart"


################################################################################
# â”€â”€ HA SENSOR IMPORTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
################################################################################

text_sensor:
  # â”€â”€ Weather â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - platform: homeassistant
    id: weather_condition
    entity_id: weather.candiac_forecast    # â† REPLACE
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_weather_condition
            text: !lambda |-
              if (x == "sunny")            return "\U000F0599";
              if (x == "clear-night")      return "\U000F0594";
              if (x == "partlycloudy")     return "\U000F0595";
              if (x == "cloudy")           return "\U000F0590";
              if (x == "rainy")            return "\U000F0597";
              if (x == "snowy")            return "\U000F0598";
              if (x == "lightning")        return "\U000F0593";
              if (x == "lightning-rainy")  return "\U000F067E";
              if (x == "windy")            return "\U000F059D";
              if (x == "fog")              return "\U000F0591";
              return "\U000F0590";

  # â”€â”€ Light states â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - platform: homeassistant
    id: state_living_room
    entity_id: light.living_room_light     # â† REPLACE
    on_value:
      then:
        - lvgl.button.update:
            id: btn_living_room
            state:
              checked: !lambda return (x == "on");

  - platform: homeassistant
    id: state_kitchen
    entity_id: light.kitchen_light         # â† REPLACE
    on_value:
      then:
        - lvgl.button.update:
            id: btn_kitchen
            state:
              checked: !lambda return (x == "on");

  - platform: homeassistant
    id: state_dining_room
    entity_id: light.dining_room_light     # â† REPLACE
    on_value:
      then:
        - lvgl.button.update:
            id: btn_dining_room
            state:
              checked: !lambda return (x == "on");

  - platform: homeassistant
    id: state_outdoor
    entity_id: light.front_door_light      # â† REPLACE
    on_value:
      then:
        - lvgl.button.update:
            id: btn_outdoor
            state:
              checked: !lambda return (x == "on");


sensor:
  - platform: homeassistant
    id: outdoor_temp
    entity_id: sensor.feels_like           # â† REPLACE
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_temperature
            text: !lambda |-
              char buf[16];
              snprintf(buf, sizeof(buf), "%.1fÂ°C", x);
              return std::string(buf);

  - platform: wifi_signal
    name: "Dashboard WiFi Signal"
    update_interval: 60s


################################################################################
# Fonts
################################################################################
font:
  - file: "gfonts://Roboto"
    id: font_clock
    size: 72
    bpp: 4

  - file: "gfonts://Roboto"
    id: font_date
    size: 26
    bpp: 4

  - file: "gfonts://Roboto"
    id: font_temp
    size: 34
    bpp: 4

  - file: "gfonts://Roboto"
    id: font_btn
    size: 22
    bpp: 4

  - file: "gfonts://Roboto"
    id: font_heading
    size: 18
    bpp: 4

  - file: "https://github.com/Templarian/MaterialDesign-Webfont/raw/master/fonts/materialdesignicons-webfont.ttf"
    id: font_icons_56
    size: 56
    bpp: 4
    glyphs:
      - "\U000F0599"  # weather-sunny
      - "\U000F0594"  # weather-night
      - "\U000F0595"  # weather-partly-cloudy
      - "\U000F0590"  # weather-cloudy
      - "\U000F0597"  # weather-rainy
      - "\U000F0598"  # weather-snowy
      - "\U000F0593"  # weather-lightning
      - "\U000F067E"  # weather-lightning-rainy
      - "\U000F059D"  # weather-windy
      - "\U000F0591"  # weather-fog

  - file: "https://github.com/Templarian/MaterialDesign-Webfont/raw/master/fonts/materialdesignicons-webfont.ttf"
    id: font_icons_32
    size: 32
    bpp: 4
    glyphs:
      - "\U000F04B9"  # mdi-sofa (living room)
      - "\U000F04E1"  # mdi-stove (kitchen)
      - "\U000F0A70"  # mdi-silverware-fork-knife (dining room)
      - "\U000F06D9"  # mdi-tree (outdoor)
      - "\U000F059A"  # mdi-weather-sunset (evening scene)
      - "\U000F0502"  # mdi-television (movie scene)
      - "\U000F0599"  # mdi-weather-sunny (morning scene)
      - "\U000F02E3"  # mdi-bed (goodnight scene)


################################################################################
# Colours
################################################################################
color:
  - id: col_bg
    hex: "111827"
  - id: col_header_bg
    hex: "1F2937"
  - id: col_divider
    hex: "374151"
  - id: col_text_primary
    hex: "F9FAFB"
  - id: col_text_secondary
    hex: "9CA3AF"
  - id: col_accent
    hex: "3B82F6"
  - id: col_btn_off
    hex: "1F2937"
  - id: col_btn_on
    hex: "D97706"
  - id: col_scene_btn
    hex: "1E3A5F"
  - id: col_scene_active
    hex: "1D4ED8"


################################################################################
# Display â€” RGB parallel interface, 800Ã—480
# *** pclk reduced to 8MHz to prevent DMA from starving WiFi ***
################################################################################
display:
  - platform: rpi_dpi_rgb
    id: my_display
    update_interval: never
    auto_clear_enabled: false
    color_order: RGB
    pclk_frequency: 14MHz     # sweet spot: display + WiFi both work
    dimensions:
      width: 800
      height: 480
    de_pin:
      number: 5
    hsync_pin:
      number: 46
      ignore_strapping_warning: true
    vsync_pin:
      number: 3
      ignore_strapping_warning: true
    pclk_pin: 7
    pclk_inverted: true
    reset_pin:
      ch422g: ch422g_hub
      number: 3
    hsync_back_porch:  8
    hsync_front_porch: 8
    hsync_pulse_width: 4
    vsync_back_porch:  16
    vsync_front_porch: 16
    vsync_pulse_width: 4
    data_pins:
      red:
        - 1
        - 2
        - 42
        - 41
        - 40
      blue:
        - 14
        - 38
        - 18
        - 17
        - 10
      green:
        - 39
        - 0
        - 45
        - 48
        - 47
        - 21


################################################################################
# Touchscreen â€” GT911 capacitive, IÂ²C
################################################################################
touchscreen:
  platform: gt911
  id: my_touch
  display: my_display
  interrupt_pin: GPIO4
  reset_pin:
    ch422g: ch422g_hub
    number: 1
    mode: OUTPUT


################################################################################
# LVGL â€” full UI definition
################################################################################
lvgl:
  color_depth: 16
  buffer_size: 15%
  log_level: WARN
  bg_color: col_bg
  text_font: font_btn
  width:  800
  height: 480
  touchscreens:
    - touchscreen_id: my_touch

  style_definitions:
    - id: style_light_btn
      radius: 12
      border_width: 2
      border_color: col_divider
      bg_color: col_btn_off
      bg_opa: COVER
      text_color: col_text_primary
      pad_all: 8

    - id: style_light_btn_checked
      bg_color: col_btn_on
      border_color: col_accent

    - id: style_scene_btn
      radius: 12
      border_width: 2
      border_color: col_divider
      bg_color: col_scene_btn
      bg_opa: COVER
      text_color: col_text_primary
      pad_all: 8

    - id: style_scene_btn_pressed
      bg_color: col_scene_active
      border_color: col_accent

    - id: style_scene_btn_checked
      bg_color: col_btn_on
      border_color: col_accent

    - id: style_section_heading
      text_color: col_text_secondary
      text_font: font_heading
      bg_opa: TRANSP
      border_opa: TRANSP
      pad_bottom: 4

  pages:
    - id: main_page
      scrollable: false
      widgets:

        # â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        - obj:
            id: header_panel
            x: 0
            y: 0
            width: 800
            height: 110
            scrollable: false
            bg_color: col_header_bg
            bg_opa: COVER
            border_width: 0
            radius: 0
            pad_all: 0
            widgets:
              - label:
                  id: lbl_clock
                  x: 24
                  y: 10
                  text_font: font_clock
                  text_color: col_text_primary
                  text: "00:00"
              - label:
                  id: lbl_date
                  x: 26
                  y: 84
                  text_font: font_date
                  text_color: col_text_secondary
                  text: "Monday, January 1"
              - obj:
                  x: 380
                  y: 12
                  width: 2
                  height: 86
                  bg_color: col_divider
                  bg_opa: COVER
                  border_width: 0
              - label:
                  id: lbl_weather_condition
                  x: 410
                  y: 14
                  text_font: font_icons_56
                  text_color: col_text_primary
                  text: "\U000F0590"
              - label:
                  id: lbl_temperature
                  x: 480
                  y: 24
                  text_font: font_temp
                  text_color: col_text_primary
                  text: "--Â°C"
              - label:
                  x: 480
                  y: 66
                  text_font: font_heading
                  text_color: col_text_secondary
                  text: "Outdoors"

        # Accent line
        - obj:
            x: 0
            y: 110
            width: 800
            height: 3
            clickable: false
            bg_color: col_accent
            bg_opa: COVER
            border_width: 0
            radius: 0

        # â”€â”€ LIGHTS â€” 2Ã—2 grid, left half â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        - label:
            x: 24
            y: 124
            styles: style_section_heading
            text: "LIGHTS"

        # Living Room (top-left)
        - button:
            id: btn_living_room
            x: 24
            y: 150
            width: 168
            height: 130
            clickable: true
            checkable: true
            styles: style_light_btn
            checked:
              styles: style_light_btn_checked
            widgets:
              - label:
                  align: CENTER
                  y: -30
                  text_font: font_icons_32
                  text: "\U000F04B9"
              - label:
                  align: CENTER
                  y: 22
                  text_font: font_btn
                  text: "Living Room"
            on_short_click:
              - homeassistant.action:
                  action: light.toggle
                  data:
                    entity_id: light.living_room_light   # â† REPLACE

        # Kitchen (top-right)
        - button:
            id: btn_kitchen
            x: 206
            y: 150
            width: 168
            height: 130
            clickable: true
            checkable: true
            styles: style_light_btn
            checked:
              styles: style_light_btn_checked
            widgets:
              - label:
                  align: CENTER
                  y: -30
                  text_font: font_icons_32
                  text: "\U000F04E1"
              - label:
                  align: CENTER
                  y: 22
                  text_font: font_btn
                  text: "Kitchen"
            on_short_click:
              - homeassistant.action:
                  action: light.toggle
                  data:
                    entity_id: light.kitchen_light       # â† REPLACE

        # Dining Room (bottom-left)
        - button:
            id: btn_dining_room
            x: 24
            y: 296
            width: 168
            height: 130
            clickable: true
            checkable: true
            styles: style_light_btn
            checked:
              styles: style_light_btn_checked
            widgets:
              - label:
                  align: CENTER
                  y: -30
                  text_font: font_icons_32
                  text: "\U000F0A70"
              - label:
                  align: CENTER
                  y: 22
                  text_font: font_btn
                  text: "Dining Room"
            on_short_click:
              - homeassistant.action:
                  action: light.toggle
                  data:
                    entity_id: light.dining_room_light   # â† REPLACE

        # Outdoor (bottom-right)
        - button:
            id: btn_outdoor
            x: 206
            y: 296
            width: 168
            height: 130
            clickable: true
            checkable: true
            styles: style_light_btn
            checked:
              styles: style_light_btn_checked
            widgets:
              - label:
                  align: CENTER
                  y: -30
                  text_font: font_icons_32
                  text: "\U000F06D9"
              - label:
                  align: CENTER
                  y: 22
                  text_font: font_btn
                  text: "Outdoor"
            on_short_click:
              - homeassistant.action:
                  action: light.toggle
                  data:
                    entity_id: light.front_door_light    # â† REPLACE

        # Vertical divider
        - obj:
            x: 400
            y: 122
            width: 2
            height: 354
            clickable: false
            bg_color: col_divider
            bg_opa: COVER
            border_width: 0

        # â”€â”€ SCENES â€” 2Ã—2 grid, right half â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        - label:
            x: 424
            y: 124
            styles: style_section_heading
            text: "SCENES"

        # Evening (top-left)
        - button:
            id: btn_scene_evening
            x: 424
            y: 150
            width: 168
            height: 130
            clickable: true
            checkable: true
            styles: style_scene_btn
            pressed:
              styles: style_scene_btn_pressed
            checked:
              styles: style_scene_btn_checked
            widgets:
              - label:
                  align: CENTER
                  y: -30
                  text_font: font_icons_32
                  text: "\U000F059A"
              - label:
                  align: CENTER
                  y: 22
                  text_font: font_btn
                  text: "Evening"
            on_short_click:
              - lvgl.button.update:
                  id: btn_scene_evening
                  state:
                    checked: true
              - lvgl.button.update:
                  id: btn_scene_movie
                  state:
                    checked: false
              - lvgl.button.update:
                  id: btn_scene_morning
                  state:
                    checked: false
              - lvgl.button.update:
                  id: btn_scene_goodnight
                  state:
                    checked: false
              - homeassistant.action:
                  action: script.turn_on
                  data:
                    entity_id: script.evening_scene      # â† REPLACE

        # Movie (top-right)
        - button:
            id: btn_scene_movie
            x: 606
            y: 150
            width: 168
            height: 130
            clickable: true
            checkable: true
            styles: style_scene_btn
            pressed:
              styles: style_scene_btn_pressed
            checked:
              styles: style_scene_btn_checked
            widgets:
              - label:
                  align: CENTER
                  y: -30
                  text_font: font_icons_32
                  text: "\U000F0502"
              - label:
                  align: CENTER
                  y: 22
                  text_font: font_btn
                  text: "Movie"
            on_short_click:
              - lvgl.button.update:
                  id: btn_scene_movie
                  state:
                    checked: true
              - lvgl.button.update:
                  id: btn_scene_evening
                  state:
                    checked: false
              - lvgl.button.update:
                  id: btn_scene_morning
                  state:
                    checked: false
              - lvgl.button.update:
                  id: btn_scene_goodnight
                  state:
                    checked: false
              - homeassistant.action:
                  action: script.turn_on
                  data:
                    entity_id: script.movie               # â† REPLACE

        # Morning (bottom-left)
        - button:
            id: btn_scene_morning
            x: 424
            y: 296
            width: 168
            height: 130
            clickable: true
            checkable: true
            styles: style_scene_btn
            pressed:
              styles: style_scene_btn_pressed
            checked:
              styles: style_scene_btn_checked
            widgets:
              - label:
                  align: CENTER
                  y: -30
                  text_font: font_icons_32
                  text: "\U000F0599"
              - label:
                  align: CENTER
                  y: 22
                  text_font: font_btn
                  text: "Morning"
            on_short_click:
              - lvgl.button.update:
                  id: btn_scene_morning
                  state:
                    checked: true
              - lvgl.button.update:
                  id: btn_scene_evening
                  state:
                    checked: false
              - lvgl.button.update:
                  id: btn_scene_movie
                  state:
                    checked: false
              - lvgl.button.update:
                  id: btn_scene_goodnight
                  state:
                    checked: false
              - homeassistant.action:
                  action: script.turn_on
                  data:
                    entity_id: script.day_scene           # â† REPLACE

        # Goodnight (bottom-right)
        - button:
            id: btn_scene_goodnight
            x: 606
            y: 296
            width: 168
            height: 130
            clickable: true
            checkable: true
            styles: style_scene_btn
            pressed:
              styles: style_scene_btn_pressed
            checked:
              styles: style_scene_btn_checked
            widgets:
              - label:
                  align: CENTER
                  y: -30
                  text_font: font_icons_32
                  text: "\U000F02E3"
              - label:
                  align: CENTER
                  y: 22
                  text_font: font_btn
                  text: "Goodnight"
            on_short_click:
              - lvgl.button.update:
                  id: btn_scene_goodnight
                  state:
                    checked: true
              - lvgl.button.update:
                  id: btn_scene_evening
                  state:
                    checked: false
              - lvgl.button.update:
                  id: btn_scene_movie
                  state:
                    checked: false
              - lvgl.button.update:
                  id: btn_scene_morning
                  state:
                    checked: false
              - homeassistant.action:
                  action: script.turn_on
                  data:
                    entity_id: script.house_off           # â† REPLACE


################################################################################
# Clock interval â€” updates every 30 seconds
################################################################################
interval:
  - interval: 30s
    then:
      - lvgl.label.update:
          id: lbl_clock
          text: !lambda |-
            auto t = id(ha_time).now();
            char buf[8];
            snprintf(buf, sizeof(buf), "%02d:%02d", t.hour, t.minute);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_date
          text: !lambda |-
            auto t = id(ha_time).now();
            static const char* days[]   = {"Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"};
            static const char* months[] = {"January","February","March","April","May","June",
                                            "July","August","September","October","November","December"};
            char buf[40];
            snprintf(buf, sizeof(buf), "%s, %s %d",
              days[t.day_of_week - 1],
              months[t.month - 1],
              t.day_of_month);
            return std::string(buf);
